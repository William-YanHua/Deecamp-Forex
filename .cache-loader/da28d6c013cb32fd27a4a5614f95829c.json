{"remainingRequest":"/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/ts-loader/index.js??ref--4-1!/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/@antv/g2plot/esm/plots/stacked-area/component/label/area-label.js","dependencies":[{"path":"/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/@antv/g2plot/esm/plots/stacked-area/component/label/area-label.js","mtime":499162500000},{"path":"/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/ts-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import { __assign } from \"tslib\";\nimport { each, deepMix, clone, find } from '@antv/util';\nvar DEFAULT_SIZE = 12;\nvar TOLERANCE = 0.01;\nvar MAX_ITERATION = 100;\nvar MIN_HEIGHT = 12;\nfunction getRange(points) {\n    var maxHeight = -Infinity;\n    var min = Infinity;\n    var max = -Infinity;\n    each(points, function (p) {\n        min = Math.min(p.x, min);\n        max = Math.max(p.x, max);\n        var height = Math.abs(p.y[0] - p.y[1]);\n        maxHeight = Math.max(maxHeight, height);\n    });\n    return {\n        xRange: [min, max],\n        maxHeight: maxHeight,\n    };\n}\nfunction interpolateY(x, points, index) {\n    var leftPoint = points[0];\n    var rightPoint = points[points.length - 1];\n    each(points, function (p) {\n        if (p.x === x) {\n            return p.y[index];\n        }\n        if (p.x < x && p.x > leftPoint.x) {\n            leftPoint = p;\n        }\n        if (p.x > x && p.x < rightPoint.x) {\n            rightPoint = p;\n        }\n    });\n    var t = (x - leftPoint.x) / (rightPoint.x - leftPoint.x);\n    return leftPoint.y[index] * (1 - t) + rightPoint.y[index] * t;\n}\nfunction getXIndex(data, x) {\n    var i;\n    for (i = 0; i < data.length; i++) {\n        var d = data[i];\n        if (d.x === x || d.x > x) {\n            break;\n        }\n    }\n    return i;\n}\nvar AreaLabel = (function () {\n    function AreaLabel(cfg) {\n        this.destroyed = false;\n        this.scaleFactor = [];\n        this.view = cfg.view;\n        this.plot = cfg.plot;\n        var defaultOptions = this.getDefaultOptions();\n        this.options = deepMix(defaultOptions, cfg, {});\n        this.init();\n    }\n    AreaLabel.prototype.init = function () {\n        var _this = this;\n        this.container = this.getGeometry().labelsContainer;\n        this.view.on('beforerender', function () {\n            _this.clear();\n            _this.plot.canvas.draw();\n        });\n    };\n    AreaLabel.prototype.render = function () {\n        var _this = this;\n        var stackField = this.plot.options.stackField;\n        var groupedPoints = this.getGeometry().dataArray;\n        var labelPoints = [];\n        each(groupedPoints, function (pointArray, name) {\n            var labelPoint = _this.drawLabel(pointArray, name);\n            if (labelPoint) {\n                labelPoints.push(deepMix({}, pointArray[0], labelPoint));\n                _this.scaleFactor.push(labelPoint.scaleFactor);\n            }\n        });\n        var labelShapes = [];\n        each(labelPoints, function (p, index) {\n            var _a = _this.options, style = _a.style, offsetX = _a.offsetX, offsetY = _a.offsetY;\n            var labelSize = _this.getFontSize(index);\n            var formatter = _this.options.formatter;\n            var content = formatter ? formatter(p._origin[stackField]) : p._origin[stackField];\n            var text = _this.container.addShape('text', {\n                attrs: deepMix({}, {\n                    x: p.x + offsetX,\n                    y: p.y + offsetY,\n                    text: content,\n                    fill: p.color,\n                    fontSize: labelSize,\n                    textAlign: 'center',\n                    textBaseline: 'top',\n                }, style),\n                name: 'label',\n            });\n            labelShapes.push(text);\n        });\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.clear = function () {\n        if (this.container) {\n            this.container.clear();\n        }\n    };\n    AreaLabel.prototype.hide = function () {\n        this.container.set('visible', false);\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.show = function () {\n        this.container.set('visible', true);\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.destroy = function () {\n        if (this.container) {\n            this.container.remove();\n        }\n        this.destroyed = true;\n    };\n    AreaLabel.prototype.getBBox = function () {\n        return this.container.getBBox();\n    };\n    AreaLabel.prototype.getDefaultOptions = function () {\n        var theme = this.plot.theme;\n        var labelStyle = clone(theme.label.style);\n        labelStyle.stroke = null;\n        delete labelStyle.fill;\n        return {\n            offsetX: 0,\n            offsetY: 0,\n            style: labelStyle,\n            autoScale: true,\n        };\n    };\n    AreaLabel.prototype.drawLabel = function (points, name) {\n        var _a = getRange(points), xRange = _a.xRange, maxHeight = _a.maxHeight;\n        var resolution = xRange[1] - xRange[0];\n        var interpolatedPoints = this.getInterpolatedPoints(xRange[0], resolution, points);\n        var bbox = this.getLabelBbox(name);\n        var fitOption = {\n            xRange: xRange,\n            aspect: bbox.width / bbox.height,\n            data: interpolatedPoints,\n            justTest: true,\n        };\n        var height = this.bisection(MIN_HEIGHT, maxHeight, this.testFit, fitOption, TOLERANCE, MAX_ITERATION);\n        if (height === null) {\n            return;\n        }\n        fitOption.justTest = false;\n        var fit = this.testFit(fitOption);\n        fit.x = fit.x;\n        fit.y = fit.y0 + (fit.y1 - fit.y0) / 2;\n        fit.scaleFactor = (height / bbox.height) * 0.2;\n        return fit;\n    };\n    AreaLabel.prototype.getInterpolatedPoints = function (minX, resolution, points) {\n        var interpolatedPoints = [];\n        var step = 2;\n        for (var i = minX; i < resolution; i += step) {\n            var y0 = interpolateY(i, points, 0);\n            var y1 = interpolateY(i, points, 1);\n            interpolatedPoints.push({\n                x: i,\n                y: [y0, y1],\n            });\n        }\n        return interpolatedPoints;\n    };\n    AreaLabel.prototype.bisection = function (min, max, test, testOption, tolerance, maxIteration) {\n        for (var i = 0; i < maxIteration; i++) {\n            var middle = (min + max) / 2;\n            var options = testOption;\n            options.height = middle;\n            options.width = middle * options.aspect;\n            var passesTest = test(options);\n            var withinTolerance = (max - min) / 2 < tolerance;\n            if (passesTest && withinTolerance) {\n                return middle;\n            }\n            if (passesTest) {\n                min = middle;\n            }\n            else {\n                max = middle;\n            }\n        }\n        return null;\n    };\n    AreaLabel.prototype.testFit = function (option) {\n        var xRange = option.xRange, width = option.width, height = option.height, data = option.data, justTest = option.justTest;\n        for (var i = 0; i < data.length; i++) {\n            var d = data[i];\n            var x0 = d.x;\n            var x1 = x0 + width;\n            if (x1 > xRange[1]) {\n                break;\n            }\n            var x1_index = getXIndex(data, x1);\n            var ceiling = -Infinity;\n            var ceilingFloor = null;\n            var floor = Infinity;\n            for (var j = i; j < x1_index; j++) {\n                var top_1 = data[j].y[1];\n                var bottom = data[j].y[0];\n                if (bottom < floor) {\n                    floor = bottom;\n                }\n                if (top_1 > ceiling) {\n                    ceiling = top_1;\n                    ceilingFloor = bottom;\n                }\n                if (floor - ceiling < height) {\n                    break;\n                }\n            }\n            if (floor - ceiling >= height) {\n                if (justTest) {\n                    return true;\n                }\n                return {\n                    x: x0,\n                    y0: ceiling,\n                    y1: ceilingFloor,\n                    width: width,\n                    height: height,\n                };\n            }\n        }\n        return false;\n    };\n    AreaLabel.prototype.getLabelBbox = function (text) {\n        var labelStyle = clone(this.plot.theme.label.textStyle);\n        labelStyle.fontSize = DEFAULT_SIZE;\n        var tShape = this.container.addShape('text', {\n            attrs: __assign({ text: text, x: 0, y: 0 }, labelStyle),\n        });\n        var bbox = tShape.getBBox();\n        tShape.remove();\n        return bbox;\n    };\n    AreaLabel.prototype.getGeometry = function () {\n        return find(this.view.geometries, function (geom) { return geom.type === 'area'; });\n    };\n    AreaLabel.prototype.getFontSize = function (index) {\n        if (this.options.autoScale) {\n            var scaleFactor = this.scaleFactor[index];\n            return DEFAULT_SIZE * scaleFactor;\n        }\n        return DEFAULT_SIZE;\n    };\n    return AreaLabel;\n}());\nexport default AreaLabel;\n",{"version":3,"file":"/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/@antv/g2plot/esm/plots/stacked-area/component/label/area-label.js","sourceRoot":"","sources":["/run/media/williamyh/新加卷/project/Deecamp-project/system/Web/node_modules/@antv/g2plot/esm/plots/stacked-area/component/label/area-label.js"],"names":[],"mappings":"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","sourcesContent":["import { __assign } from \"tslib\";\nimport { each, deepMix, clone, find } from '@antv/util';\nvar DEFAULT_SIZE = 12;\nvar TOLERANCE = 0.01;\nvar MAX_ITERATION = 100;\nvar MIN_HEIGHT = 12;\nfunction getRange(points) {\n    var maxHeight = -Infinity;\n    var min = Infinity;\n    var max = -Infinity;\n    each(points, function (p) {\n        min = Math.min(p.x, min);\n        max = Math.max(p.x, max);\n        var height = Math.abs(p.y[0] - p.y[1]);\n        maxHeight = Math.max(maxHeight, height);\n    });\n    return {\n        xRange: [min, max],\n        maxHeight: maxHeight,\n    };\n}\nfunction interpolateY(x, points, index) {\n    var leftPoint = points[0];\n    var rightPoint = points[points.length - 1];\n    each(points, function (p) {\n        if (p.x === x) {\n            return p.y[index];\n        }\n        if (p.x < x && p.x > leftPoint.x) {\n            leftPoint = p;\n        }\n        if (p.x > x && p.x < rightPoint.x) {\n            rightPoint = p;\n        }\n    });\n    var t = (x - leftPoint.x) / (rightPoint.x - leftPoint.x);\n    return leftPoint.y[index] * (1 - t) + rightPoint.y[index] * t;\n}\nfunction getXIndex(data, x) {\n    // tslint:disable-next-line: prefer-for-of\n    var i;\n    for (i = 0; i < data.length; i++) {\n        var d = data[i];\n        if (d.x === x || d.x > x) {\n            break;\n        }\n    }\n    return i;\n}\nvar AreaLabel = /** @class */ (function () {\n    function AreaLabel(cfg) {\n        this.destroyed = false;\n        this.scaleFactor = [];\n        this.view = cfg.view;\n        this.plot = cfg.plot;\n        var defaultOptions = this.getDefaultOptions();\n        this.options = deepMix(defaultOptions, cfg, {});\n        this.init();\n    }\n    AreaLabel.prototype.init = function () {\n        var _this = this;\n        this.container = this.getGeometry().labelsContainer;\n        this.view.on('beforerender', function () {\n            _this.clear();\n            _this.plot.canvas.draw();\n        });\n    };\n    AreaLabel.prototype.render = function () {\n        var _this = this;\n        var stackField = this.plot.options.stackField;\n        var groupedPoints = this.getGeometry().dataArray;\n        var labelPoints = [];\n        each(groupedPoints, function (pointArray, name) {\n            var labelPoint = _this.drawLabel(pointArray, name);\n            if (labelPoint) {\n                labelPoints.push(deepMix({}, pointArray[0], labelPoint));\n                _this.scaleFactor.push(labelPoint.scaleFactor);\n            }\n        });\n        var labelShapes = [];\n        each(labelPoints, function (p, index) {\n            var _a = _this.options, style = _a.style, offsetX = _a.offsetX, offsetY = _a.offsetY;\n            var labelSize = _this.getFontSize(index);\n            var formatter = _this.options.formatter;\n            var content = formatter ? formatter(p._origin[stackField]) : p._origin[stackField];\n            var text = _this.container.addShape('text', {\n                attrs: deepMix({}, {\n                    x: p.x + offsetX,\n                    y: p.y + offsetY,\n                    text: content,\n                    fill: p.color,\n                    fontSize: labelSize,\n                    textAlign: 'center',\n                    textBaseline: 'top',\n                }, style),\n                name: 'label',\n            });\n            labelShapes.push(text);\n        });\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.clear = function () {\n        if (this.container) {\n            this.container.clear();\n        }\n    };\n    AreaLabel.prototype.hide = function () {\n        this.container.set('visible', false);\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.show = function () {\n        this.container.set('visible', true);\n        this.plot.canvas.draw();\n    };\n    AreaLabel.prototype.destroy = function () {\n        if (this.container) {\n            this.container.remove();\n        }\n        this.destroyed = true;\n    };\n    AreaLabel.prototype.getBBox = function () {\n        return this.container.getBBox();\n    };\n    AreaLabel.prototype.getDefaultOptions = function () {\n        var theme = this.plot.theme;\n        var labelStyle = clone(theme.label.style);\n        labelStyle.stroke = null;\n        delete labelStyle.fill;\n        return {\n            offsetX: 0,\n            offsetY: 0,\n            style: labelStyle,\n            autoScale: true,\n        };\n    };\n    AreaLabel.prototype.drawLabel = function (points, name) {\n        var _a = getRange(points), xRange = _a.xRange, maxHeight = _a.maxHeight;\n        // 根据area宽度在x方向各点间做插值\n        var resolution = xRange[1] - xRange[0];\n        var interpolatedPoints = this.getInterpolatedPoints(xRange[0], resolution, points);\n        // 获取label的bbox\n        var bbox = this.getLabelBbox(name);\n        var fitOption = {\n            xRange: xRange,\n            aspect: bbox.width / bbox.height,\n            data: interpolatedPoints,\n            justTest: true,\n        };\n        var height = this.bisection(MIN_HEIGHT, maxHeight, this.testFit, fitOption, TOLERANCE, MAX_ITERATION);\n        if (height === null) {\n            return;\n        }\n        fitOption.justTest = false;\n        var fit = this.testFit(fitOption);\n        fit.x = fit.x;\n        fit.y = fit.y0 + (fit.y1 - fit.y0) / 2;\n        fit.scaleFactor = (height / bbox.height) * 0.2;\n        return fit;\n    };\n    AreaLabel.prototype.getInterpolatedPoints = function (minX, resolution, points) {\n        var interpolatedPoints = [];\n        var step = 2;\n        for (var i = minX; i < resolution; i += step) {\n            var y0 = interpolateY(i, points, 0);\n            var y1 = interpolateY(i, points, 1);\n            interpolatedPoints.push({\n                x: i,\n                y: [y0, y1],\n            });\n        }\n        return interpolatedPoints;\n    };\n    AreaLabel.prototype.bisection = function (min, max, test, testOption, tolerance, maxIteration) {\n        for (var i = 0; i < maxIteration; i++) {\n            var middle = (min + max) / 2;\n            var options = testOption;\n            options.height = middle;\n            options.width = middle * options.aspect;\n            var passesTest = test(options);\n            var withinTolerance = (max - min) / 2 < tolerance;\n            if (passesTest && withinTolerance) {\n                return middle;\n            }\n            if (passesTest) {\n                min = middle;\n            }\n            else {\n                max = middle;\n            }\n        }\n        return null;\n    };\n    AreaLabel.prototype.testFit = function (option) {\n        var xRange = option.xRange, width = option.width, height = option.height, data = option.data, justTest = option.justTest;\n        for (var i = 0; i < data.length; i++) {\n            var d = data[i];\n            var x0 = d.x;\n            var x1 = x0 + width;\n            if (x1 > xRange[1]) {\n                break;\n            }\n            var x1_index = getXIndex(data, x1);\n            var ceiling = -Infinity;\n            var ceilingFloor = null; // 保存ceiling时对应的bottom位置，ceil和floor不一定是一对坐标\n            var floor = Infinity;\n            for (var j = i; j < x1_index; j++) {\n                var top_1 = data[j].y[1];\n                var bottom = data[j].y[0];\n                if (bottom < floor) {\n                    floor = bottom;\n                }\n                if (top_1 > ceiling) {\n                    ceiling = top_1;\n                    ceilingFloor = bottom;\n                }\n                if (floor - ceiling < height) {\n                    break;\n                }\n            }\n            if (floor - ceiling >= height) {\n                if (justTest) {\n                    return true;\n                }\n                return {\n                    x: x0,\n                    y0: ceiling,\n                    y1: ceilingFloor,\n                    width: width,\n                    height: height,\n                };\n            }\n        }\n        return false;\n    };\n    AreaLabel.prototype.getLabelBbox = function (text) {\n        var labelStyle = clone(this.plot.theme.label.textStyle);\n        labelStyle.fontSize = DEFAULT_SIZE;\n        var tShape = this.container.addShape('text', {\n            attrs: __assign({ text: text, x: 0, y: 0 }, labelStyle),\n        });\n        var bbox = tShape.getBBox();\n        tShape.remove();\n        return bbox;\n    };\n    AreaLabel.prototype.getGeometry = function () {\n        return find(this.view.geometries, function (geom) { return geom.type === 'area'; });\n    };\n    AreaLabel.prototype.getFontSize = function (index) {\n        if (this.options.autoScale) {\n            var scaleFactor = this.scaleFactor[index];\n            return DEFAULT_SIZE * scaleFactor;\n        }\n        return DEFAULT_SIZE;\n    };\n    return AreaLabel;\n}());\nexport default AreaLabel;\n//# sourceMappingURL=area-label.js.map"]}]}