{"remainingRequest":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\ts-loader\\index.js??ref--4-1!D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\node_modules\\@antv\\g2\\lib\\interaction\\grammar-interaction.js","dependencies":[{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\node_modules\\@antv\\g2\\lib\\interaction\\grammar-interaction.js","mtime":499162500000},{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1595520254649},{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\ts-loader\\index.js","mtime":1537906253000}],"contextDependencies":[],"result":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar tslib_1 = require(\"tslib\");\r\nvar util_1 = require(\"@antv/util\");\r\nvar register_1 = require(\"./action/register\");\r\nvar context_1 = tslib_1.__importDefault(require(\"./context\"));\r\nvar interaction_1 = tslib_1.__importDefault(require(\"./interaction\"));\r\nfunction parseAction(actionStr, context) {\r\n    var arr = actionStr.split(':');\r\n    var actionName = arr[0];\r\n    var action = context.getAction(actionName) || register_1.createAction(actionName, context);\r\n    if (!action) {\r\n        throw new Error(\"There is no action named \" + actionName);\r\n    }\r\n    var methodName = arr[1];\r\n    return {\r\n        action: action,\r\n        methodName: methodName,\r\n    };\r\n}\r\nfunction executeAction(actionObject) {\r\n    var action = actionObject.action, methodName = actionObject.methodName;\r\n    if (action[methodName]) {\r\n        action[methodName]();\r\n    }\r\n    else {\r\n        throw new Error(\"Action(\" + action.name + \") doesn't have a method called \" + methodName);\r\n    }\r\n}\r\nvar STEP_NAMES = {\r\n    START: 'start',\r\n    SHOW_ENABLE: 'showEnable',\r\n    END: 'end',\r\n    ROLLBACK: 'rollback',\r\n    PROCESSING: 'processing',\r\n};\r\nvar GrammarInteraction = (function (_super) {\r\n    tslib_1.__extends(GrammarInteraction, _super);\r\n    function GrammarInteraction(view, steps) {\r\n        var _this = _super.call(this, view, steps) || this;\r\n        _this.callbackCaches = {};\r\n        _this.emitCaches = {};\r\n        _this.steps = steps;\r\n        return _this;\r\n    }\r\n    GrammarInteraction.prototype.init = function () {\r\n        this.initContext();\r\n        _super.prototype.init.call(this);\r\n    };\r\n    GrammarInteraction.prototype.destroy = function () {\r\n        _super.prototype.destroy.call(this);\r\n        this.steps = null;\r\n        if (this.context) {\r\n            this.context.destroy();\r\n            this.context = null;\r\n        }\r\n        this.callbackCaches = null;\r\n        this.view = null;\r\n    };\r\n    GrammarInteraction.prototype.initEvents = function () {\r\n        var _this = this;\r\n        util_1.each(this.steps, function (stepArr, stepName) {\r\n            util_1.each(stepArr, function (step) {\r\n                var callback = _this.getActionCallback(stepName, step);\r\n                if (callback) {\r\n                    _this.bindEvent(step.trigger, callback);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GrammarInteraction.prototype.clearEvents = function () {\r\n        var _this = this;\r\n        util_1.each(this.steps, function (stepArr, stepName) {\r\n            util_1.each(stepArr, function (step) {\r\n                var callback = _this.getActionCallback(stepName, step);\r\n                if (callback) {\r\n                    _this.offEvent(step.trigger, callback);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GrammarInteraction.prototype.initContext = function () {\r\n        var view = this.view;\r\n        var context = new context_1.default(view);\r\n        this.context = context;\r\n        var steps = this.steps;\r\n        util_1.each(steps, function (subSteps) {\r\n            util_1.each(subSteps, function (step) {\r\n                if (util_1.isFunction(step.action)) {\r\n                    step.actionObject = {\r\n                        action: register_1.createCallbackAction(step.action, context),\r\n                        methodName: 'execute',\r\n                    };\r\n                }\r\n                else if (util_1.isString(step.action)) {\r\n                    step.actionObject = parseAction(step.action, context);\r\n                }\r\n                else if (util_1.isArray(step.action)) {\r\n                    var actionArr = step.action;\r\n                    step.actionObject = [];\r\n                    util_1.each(actionArr, function (actionStr) {\r\n                        step.actionObject.push(parseAction(actionStr, context));\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    };\r\n    GrammarInteraction.prototype.isAllowStep = function (stepName) {\r\n        var currentStepName = this.currentStepName;\r\n        var steps = this.steps;\r\n        if (currentStepName === stepName) {\r\n            return true;\r\n        }\r\n        if (stepName === STEP_NAMES.SHOW_ENABLE) {\r\n            return true;\r\n        }\r\n        if (stepName === STEP_NAMES.PROCESSING) {\r\n            return currentStepName === STEP_NAMES.START;\r\n        }\r\n        if (stepName === STEP_NAMES.START) {\r\n            return currentStepName !== STEP_NAMES.PROCESSING;\r\n        }\r\n        if (stepName === STEP_NAMES.END) {\r\n            return currentStepName === STEP_NAMES.PROCESSING || currentStepName === STEP_NAMES.START;\r\n        }\r\n        if (stepName === STEP_NAMES.ROLLBACK) {\r\n            if (steps[STEP_NAMES.END]) {\r\n                return currentStepName === STEP_NAMES.END;\r\n            }\r\n            else if (currentStepName === STEP_NAMES.START) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n    GrammarInteraction.prototype.isAllowExcute = function (stepName, step) {\r\n        if (this.isAllowStep(stepName)) {\r\n            var key = this.getKey(stepName, step);\r\n            if (step.once && this.emitCaches[key]) {\r\n                return false;\r\n            }\r\n            if (step.isEnable) {\r\n                return step.isEnable(this.context);\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    };\r\n    GrammarInteraction.prototype.enterStep = function (stepName) {\r\n        this.currentStepName = stepName;\r\n        this.emitCaches = {};\r\n    };\r\n    GrammarInteraction.prototype.afterExecute = function (stepName, step) {\r\n        if (stepName !== STEP_NAMES.SHOW_ENABLE && this.currentStepName !== stepName) {\r\n            this.enterStep(stepName);\r\n        }\r\n        var key = this.getKey(stepName, step);\r\n        this.emitCaches[key] = true;\r\n    };\r\n    GrammarInteraction.prototype.getKey = function (stepName, step) {\r\n        return stepName + step.trigger + step.action;\r\n    };\r\n    GrammarInteraction.prototype.getActionCallback = function (stepName, step) {\r\n        var _this = this;\r\n        var context = this.context;\r\n        var callbackCaches = this.callbackCaches;\r\n        var actionObject = step.actionObject;\r\n        if (step.action && actionObject) {\r\n            var key = this.getKey(stepName, step);\r\n            if (!callbackCaches[key]) {\r\n                var actionCallback = function (event) {\r\n                    context.event = event;\r\n                    if (_this.isAllowExcute(stepName, step)) {\r\n                        if (util_1.isArray(actionObject)) {\r\n                            util_1.each(actionObject, function (obj) {\r\n                                context.event = event;\r\n                                executeAction(obj);\r\n                            });\r\n                        }\r\n                        else {\r\n                            context.event = event;\r\n                            executeAction(actionObject);\r\n                        }\r\n                        _this.afterExecute(stepName, step);\r\n                        if (step.callback) {\r\n                            context.event = event;\r\n                            step.callback(context);\r\n                        }\r\n                    }\r\n                    else {\r\n                        context.event = null;\r\n                    }\r\n                };\r\n                if (step.debounce) {\r\n                    callbackCaches[key] = util_1.debounce(actionCallback, step.debounce.wait, step.debounce.immediate);\r\n                }\r\n                else if (step.throttle) {\r\n                    callbackCaches[key] = util_1.throttle(actionCallback, step.throttle.wait, {\r\n                        leading: step.throttle.leading,\r\n                        trailing: step.throttle.trailing,\r\n                    });\r\n                }\r\n                else {\r\n                    callbackCaches[key] = actionCallback;\r\n                }\r\n            }\r\n            return callbackCaches[key];\r\n        }\r\n        return null;\r\n    };\r\n    GrammarInteraction.prototype.bindEvent = function (eventName, callback) {\r\n        var nameArr = eventName.split(':');\r\n        if (nameArr[0] === 'window') {\r\n            window.addEventListener(nameArr[1], callback);\r\n        }\r\n        else if (nameArr[0] === 'document') {\r\n            document.addEventListener(nameArr[1], callback);\r\n        }\r\n        else {\r\n            this.view.on(eventName, callback);\r\n        }\r\n    };\r\n    GrammarInteraction.prototype.offEvent = function (eventName, callback) {\r\n        var nameArr = eventName.split(':');\r\n        if (nameArr[0] === 'window') {\r\n            window.removeEventListener(nameArr[1], callback);\r\n        }\r\n        else if (nameArr[0] === 'document') {\r\n            document.removeEventListener(nameArr[1], callback);\r\n        }\r\n        else {\r\n            this.view.off(eventName, callback);\r\n        }\r\n    };\r\n    return GrammarInteraction;\r\n}(interaction_1.default));\r\nexports.default = GrammarInteraction;\r\n",{"version":3,"file":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\node_modules\\@antv\\g2\\lib\\interaction\\grammar-interaction.js","sourceRoot":"","sources":["D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\node_modules\\@antv\\g2\\lib\\interaction\\grammar-interaction.js"],"names":[],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar util_1 = require(\"@antv/util\");\nvar register_1 = require(\"./action/register\");\nvar context_1 = tslib_1.__importDefault(require(\"./context\"));\nvar interaction_1 = tslib_1.__importDefault(require(\"./interaction\"));\n// 将字符串转换成 action\nfunction parseAction(actionStr, context) {\n    var arr = actionStr.split(':');\n    var actionName = arr[0];\n    // 如果已经初始化过 action ，则直接引用之前的 action\n    var action = context.getAction(actionName) || register_1.createAction(actionName, context);\n    if (!action) {\n        throw new Error(\"There is no action named \" + actionName);\n    }\n    var methodName = arr[1];\n    return {\n        action: action,\n        methodName: methodName,\n    };\n}\n// 执行 Action\nfunction executeAction(actionObject) {\n    var action = actionObject.action, methodName = actionObject.methodName;\n    if (action[methodName]) {\n        action[methodName]();\n    }\n    else {\n        throw new Error(\"Action(\" + action.name + \") doesn't have a method called \" + methodName);\n    }\n}\nvar STEP_NAMES = {\n    START: 'start',\n    SHOW_ENABLE: 'showEnable',\n    END: 'end',\n    ROLLBACK: 'rollback',\n    PROCESSING: 'processing',\n};\n/**\n * 支持语法的交互类\n */\nvar GrammarInteraction = /** @class */ (function (_super) {\n    tslib_1.__extends(GrammarInteraction, _super);\n    function GrammarInteraction(view, steps) {\n        var _this = _super.call(this, view, steps) || this;\n        _this.callbackCaches = {};\n        // 某个触发和反馈在本环节是否执行或\n        _this.emitCaches = {};\n        _this.steps = steps;\n        return _this;\n    }\n    /**\n     * 初始化\n     */\n    GrammarInteraction.prototype.init = function () {\n        this.initContext();\n        _super.prototype.init.call(this);\n    };\n    /**\n     * 清理资源\n     */\n    GrammarInteraction.prototype.destroy = function () {\n        _super.prototype.destroy.call(this); // 先清理事件\n        this.steps = null;\n        if (this.context) {\n            this.context.destroy();\n            this.context = null;\n        }\n        this.callbackCaches = null;\n        this.view = null;\n    };\n    /**\n     * 绑定事件\n     */\n    GrammarInteraction.prototype.initEvents = function () {\n        var _this = this;\n        util_1.each(this.steps, function (stepArr, stepName) {\n            util_1.each(stepArr, function (step) {\n                var callback = _this.getActionCallback(stepName, step);\n                if (callback) {\n                    // 如果存在 callback，才绑定，有时候会出现无 callback 的情况\n                    _this.bindEvent(step.trigger, callback);\n                }\n            });\n        });\n    };\n    /**\n     * 清理绑定的事件\n     */\n    GrammarInteraction.prototype.clearEvents = function () {\n        var _this = this;\n        util_1.each(this.steps, function (stepArr, stepName) {\n            util_1.each(stepArr, function (step) {\n                var callback = _this.getActionCallback(stepName, step);\n                if (callback) {\n                    _this.offEvent(step.trigger, callback);\n                }\n            });\n        });\n    };\n    // 初始化上下文，并初始化 action\n    GrammarInteraction.prototype.initContext = function () {\n        var view = this.view;\n        var context = new context_1.default(view);\n        this.context = context;\n        var steps = this.steps;\n        // 生成具体的 Action\n        util_1.each(steps, function (subSteps) {\n            util_1.each(subSteps, function (step) {\n                if (util_1.isFunction(step.action)) {\n                    // 如果传入回调函数，则直接生成 CallbackAction\n                    step.actionObject = {\n                        action: register_1.createCallbackAction(step.action, context),\n                        methodName: 'execute',\n                    };\n                }\n                else if (util_1.isString(step.action)) {\n                    // 如果是字符串\n                    step.actionObject = parseAction(step.action, context);\n                }\n                else if (util_1.isArray(step.action)) {\n                    // 如果是数组\n                    var actionArr = step.action;\n                    step.actionObject = [];\n                    util_1.each(actionArr, function (actionStr) {\n                        step.actionObject.push(parseAction(actionStr, context));\n                    });\n                }\n                // 如果 action 既不是字符串，也不是函数，则不会生成 actionObject\n            });\n        });\n    };\n    // 是否允许指定阶段名称执行\n    GrammarInteraction.prototype.isAllowStep = function (stepName) {\n        var currentStepName = this.currentStepName;\n        var steps = this.steps;\n        // 相同的阶段允许同时执行\n        if (currentStepName === stepName) {\n            return true;\n        }\n        if (stepName === STEP_NAMES.SHOW_ENABLE) {\n            // 示能在整个过程中都可用\n            return true;\n        }\n        if (stepName === STEP_NAMES.PROCESSING) {\n            // 只有当前是 start 时，才允许 processing\n            return currentStepName === STEP_NAMES.START;\n        }\n        if (stepName === STEP_NAMES.START) {\n            // 如果当前是 processing，则无法 start，必须等待 end 后才能执行\n            return currentStepName !== STEP_NAMES.PROCESSING;\n        }\n        if (stepName === STEP_NAMES.END) {\n            return currentStepName === STEP_NAMES.PROCESSING || currentStepName === STEP_NAMES.START;\n        }\n        if (stepName === STEP_NAMES.ROLLBACK) {\n            if (steps[STEP_NAMES.END]) {\n                // 如果定义了 end, 只有 end 时才允许回滚\n                return currentStepName === STEP_NAMES.END;\n            }\n            else if (currentStepName === STEP_NAMES.START) {\n                // 如果未定义 end, 则判断是否是开始\n                return true;\n            }\n        }\n        return false;\n    };\n    // 具体的指定阶段是否允许执行\n    GrammarInteraction.prototype.isAllowExcute = function (stepName, step) {\n        if (this.isAllowStep(stepName)) {\n            var key = this.getKey(stepName, step);\n            // 如果是在本环节内仅允许触发一次，同时已经触发过，则不允许再触发\n            if (step.once && this.emitCaches[key]) {\n                return false;\n            }\n            // 如果是允许的阶段，则验证 isEnable 方法\n            if (step.isEnable) {\n                return step.isEnable(this.context);\n            }\n            return true; // 如果没有 isEnable 则允许执行\n        }\n        return false;\n    };\n    GrammarInteraction.prototype.enterStep = function (stepName) {\n        this.currentStepName = stepName;\n        this.emitCaches = {}; // 清除所有本环节触发的缓存\n    };\n    // 执行完某个触发和反馈（子环节）\n    GrammarInteraction.prototype.afterExecute = function (stepName, step) {\n        // show enable 不计入正常的流程，其他情况则设置当前的 step\n        if (stepName !== STEP_NAMES.SHOW_ENABLE && this.currentStepName !== stepName) {\n            this.enterStep(stepName);\n        }\n        var key = this.getKey(stepName, step);\n        // 一旦执行，则缓存标记为，一直保持到跳出改环节\n        this.emitCaches[key] = true;\n    };\n    // 获取某个环节的唯一的键值\n    GrammarInteraction.prototype.getKey = function (stepName, step) {\n        return stepName + step.trigger + step.action;\n    };\n    // 获取 step 的回调函数，如果已经生成，则直接返回，如果未生成，则创建\n    GrammarInteraction.prototype.getActionCallback = function (stepName, step) {\n        var _this = this;\n        var context = this.context;\n        var callbackCaches = this.callbackCaches;\n        var actionObject = step.actionObject;\n        if (step.action && actionObject) {\n            var key = this.getKey(stepName, step);\n            if (!callbackCaches[key]) {\n                // 动态生成执行的方法，执行对应 action 的名称\n                var actionCallback = function (event) {\n                    context.event = event; // 保证检测时的 event\n                    if (_this.isAllowExcute(stepName, step)) {\n                        // 如果是数组时，则依次执行\n                        if (util_1.isArray(actionObject)) {\n                            util_1.each(actionObject, function (obj) {\n                                context.event = event; // 可能触发新的事件，保证执行前的 context.event 是正确的\n                                executeAction(obj);\n                            });\n                        }\n                        else {\n                            context.event = event; // 保证执行前的 context.event 是正确的\n                            executeAction(actionObject);\n                        }\n                        _this.afterExecute(stepName, step);\n                        if (step.callback) {\n                            context.event = event; // 保证执行前的 context.event 是正确的\n                            step.callback(context);\n                        }\n                    }\n                    else {\n                        // 如果未通过验证，则事件不要绑定在上面\n                        context.event = null;\n                    }\n                };\n                // 如果设置了 debounce\n                if (step.debounce) {\n                    callbackCaches[key] = util_1.debounce(actionCallback, step.debounce.wait, step.debounce.immediate);\n                }\n                else if (step.throttle) {\n                    // 设置 throttle\n                    callbackCaches[key] = util_1.throttle(actionCallback, step.throttle.wait, {\n                        leading: step.throttle.leading,\n                        trailing: step.throttle.trailing,\n                    });\n                }\n                else {\n                    // 直接设置\n                    callbackCaches[key] = actionCallback;\n                }\n            }\n            return callbackCaches[key];\n        }\n        return null;\n    };\n    GrammarInteraction.prototype.bindEvent = function (eventName, callback) {\n        var nameArr = eventName.split(':');\n        if (nameArr[0] === 'window') {\n            window.addEventListener(nameArr[1], callback);\n        }\n        else if (nameArr[0] === 'document') {\n            document.addEventListener(nameArr[1], callback);\n        }\n        else {\n            this.view.on(eventName, callback);\n        }\n    };\n    GrammarInteraction.prototype.offEvent = function (eventName, callback) {\n        var nameArr = eventName.split(':');\n        if (nameArr[0] === 'window') {\n            window.removeEventListener(nameArr[1], callback);\n        }\n        else if (nameArr[0] === 'document') {\n            document.removeEventListener(nameArr[1], callback);\n        }\n        else {\n            this.view.off(eventName, callback);\n        }\n    };\n    return GrammarInteraction;\n}(interaction_1.default));\nexports.default = GrammarInteraction;\n//# sourceMappingURL=grammar-interaction.js.map"]}]}