{"remainingRequest":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\ts-loader\\index.js??ref--4-1!D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\esm\\plots\\pie\\component\\label\\outer-label.js","dependencies":[{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\esm\\plots\\pie\\component\\label\\outer-label.js","mtime":499162500000},{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1595520254649},{"path":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\ts-loader\\index.js","mtime":1537906253000}],"contextDependencies":[],"result":["import { __assign, __extends } from \"tslib\";\r\nimport { filter, head, last, map } from '@antv/util';\r\nimport PieBaseLabel from './base-label';\r\nimport { getEndPoint } from './utils';\r\nexport var DEFAULT_OFFSET = 16;\r\nvar PieOuterLabel = (function (_super) {\r\n    __extends(PieOuterLabel, _super);\r\n    function PieOuterLabel() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    PieOuterLabel.prototype.adjustOption = function (options) {\r\n        _super.prototype.adjustOption.call(this, options);\r\n        if (options.offset < 0) {\r\n            options.offset = 0;\r\n        }\r\n    };\r\n    PieOuterLabel.prototype.getDefaultOptions = function () {\r\n        var theme = this.plot.theme;\r\n        var labelStyle = theme.label.style;\r\n        return {\r\n            offsetX: 0,\r\n            offsetY: 0,\r\n            offset: 12,\r\n            style: __assign(__assign({}, labelStyle), { textBaseline: 'middle' }),\r\n        };\r\n    };\r\n    PieOuterLabel.prototype.layout = function (labels, items, panel) {\r\n        var _this = this;\r\n        var center = this.getCoordinate().center;\r\n        var leftHalf = filter(labels, function (l) { return l.attr('x') <= center.x; });\r\n        var rightHalf = filter(labels, function (l) { return l.attr('x') > center.x; });\r\n        [rightHalf, leftHalf].forEach(function (half, isLeft) {\r\n            _this._antiCollision(half, !isLeft, panel);\r\n        });\r\n    };\r\n    PieOuterLabel.prototype._antiCollision = function (labels, isRight, panelBox) {\r\n        var _this = this;\r\n        var labelHeight = this.getLabelHeight(labels);\r\n        var _a = this.getCoordinate(), center = _a.center, radius = _a.radius;\r\n        var offset = this.options.offset;\r\n        var totalR = radius + offset;\r\n        var totalHeight = Math.min(panelBox.height, Math.max(totalR * 2 + labelHeight * 2, labels.length * labelHeight));\r\n        var maxLabelsCount = Math.floor(totalHeight / labelHeight);\r\n        if (!this.options.allowOverlap) {\r\n            labels.slice(maxLabelsCount).forEach(function (label) {\r\n                label.get('parent').set('visible', false);\r\n            });\r\n        }\r\n        labels.splice(maxLabelsCount, labels.length - maxLabelsCount);\r\n        labels.sort(function (a, b) { return a.getBBox().y - b.getBBox().y; });\r\n        var overlapping = true;\r\n        var i;\r\n        var maxY = center.y + totalHeight / 2;\r\n        var minY = center.y - totalHeight / 2;\r\n        var boxes = labels.map(function (label) {\r\n            var labelBox = label.getBBox();\r\n            if (labelBox.maxY > maxY) {\r\n                maxY = Math.min(panelBox.maxY, labelBox.maxY);\r\n            }\r\n            if (labelBox.minY < minY) {\r\n                minY = Math.max(panelBox.minY, labelBox.minY);\r\n            }\r\n            return {\r\n                text: label.attr('text'),\r\n                size: labelHeight,\r\n                pos: labelBox.y,\r\n                targets: [],\r\n            };\r\n        });\r\n        var j = 0;\r\n        while (j < boxes.length) {\r\n            if (j === boxes.length - 1) {\r\n                boxes[j].targets[0] = maxY;\r\n            }\r\n            else {\r\n                boxes[j].targets[0] = boxes[j + 1].pos - boxes[j + 1].size / 2;\r\n            }\r\n            j++;\r\n        }\r\n        while (overlapping) {\r\n            boxes.forEach(function (box) {\r\n                var target = last(box.targets);\r\n                box.pos = Math.max(minY, Math.min(box.pos, target - box.size));\r\n            });\r\n            overlapping = false;\r\n            i = boxes.length;\r\n            while (i--) {\r\n                if (i > 0) {\r\n                    var previousBox = boxes[i - 1];\r\n                    var box = boxes[i];\r\n                    if (previousBox.pos + previousBox.size > box.pos) {\r\n                        previousBox.size += box.size;\r\n                        previousBox.targets = previousBox.targets.concat(box.targets);\r\n                        var target = last(previousBox.targets);\r\n                        if (previousBox.pos + previousBox.size > target) {\r\n                            previousBox.pos = target - previousBox.size;\r\n                        }\r\n                        boxes.splice(i, 1);\r\n                        overlapping = true;\r\n                    }\r\n                    else {\r\n                        previousBox.targets.splice(-1, 1, box.pos);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        i = 0;\r\n        boxes.forEach(function (b) {\r\n            var posInCompositeBox = labelHeight / 2;\r\n            b.targets.forEach(function () {\r\n                labels[i].attr('y', b.pos + posInCompositeBox);\r\n                posInCompositeBox += labelHeight;\r\n                i++;\r\n            });\r\n        });\r\n        var topLabels = [];\r\n        var bottomLabels = [];\r\n        labels.forEach(function (label, idx) {\r\n            var anchor = _this.arcPoints[idx];\r\n            if (anchor.angle >= 0 && anchor.angle <= Math.PI) {\r\n                bottomLabels.push(label);\r\n            }\r\n            else {\r\n                topLabels.push(label);\r\n            }\r\n        });\r\n        [topLabels, bottomLabels].forEach(function (adjustLabels, isBottom) {\r\n            if (!adjustLabels.length) {\r\n                return;\r\n            }\r\n            var ry = isBottom ? last(adjustLabels).getBBox().maxY - center.y : center.y - head(adjustLabels).getBBox().minY;\r\n            ry = Math.max(totalR, ry);\r\n            var distance = offset > 4 ? 4 : 0;\r\n            var maxLabelWidth = Math.max.apply(0, map(labels, function (label) { return label.getBBox().width; })) +\r\n                offset +\r\n                distance;\r\n            var rx = Math.max(totalR, Math.min((ry + totalR) / 2, center.x - (panelBox.minX + maxLabelWidth)));\r\n            var rxPow2 = rx * rx;\r\n            var ryPow2 = ry * ry;\r\n            adjustLabels.forEach(function (label, idx) {\r\n                var anchor = _this.arcPoints[idx];\r\n                var box = label.getBBox();\r\n                var boxCenter = { x: box.minX + box.width / 2, y: box.minY + box.height / 2 };\r\n                var dyPow2 = Math.pow(boxCenter.y - center.y, 2);\r\n                var endPoint = getEndPoint(center, anchor.angle, radius);\r\n                var distance_offset = (isRight ? 1 : -1) * distance * 2;\r\n                if (dyPow2 > ryPow2) {\r\n                    console.warn('异常(一般不会出现)', label.attr('text'));\r\n                    label.attr('x', endPoint.x + distance_offset);\r\n                }\r\n                else {\r\n                    var xPos = center.x + (isRight ? 1 : -1) * Math.sqrt((1 - dyPow2 / ryPow2) * rxPow2);\r\n                    if ((center.x === endPoint.x && boxCenter.y === endPoint.y) ||\r\n                        (center.y === endPoint.y && xPos === endPoint.x)) {\r\n                        xPos = endPoint.x;\r\n                    }\r\n                    else {\r\n                    }\r\n                    label.attr('x', xPos + distance_offset);\r\n                }\r\n            });\r\n        });\r\n    };\r\n    PieOuterLabel.prototype.getLabelHeight = function (labels) {\r\n        if (!this.options.labelHeight) {\r\n            return head(labels) ? head(labels).getBBox().height : 14;\r\n        }\r\n        return this.options.labelHeight;\r\n    };\r\n    return PieOuterLabel;\r\n}(PieBaseLabel));\r\nexport default PieOuterLabel;\r\n",{"version":3,"file":"D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\esm\\plots\\pie\\component\\label\\outer-label.js","sourceRoot":"","sources":["D:\\project\\Deecamp-project\\system\\Web\\node_modules\\@antv\\g2plot\\esm\\plots\\pie\\component\\label\\outer-label.js"],"names":[],"mappings":"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","sourcesContent":["import { __assign, __extends } from \"tslib\";\nimport { filter, head, last, map } from '@antv/util';\nimport PieBaseLabel from './base-label';\nimport { getEndPoint } from './utils';\n// 默认label和element的偏移 16px\nexport var DEFAULT_OFFSET = 16;\nvar PieOuterLabel = /** @class */ (function (_super) {\n    __extends(PieOuterLabel, _super);\n    function PieOuterLabel() {\n        return _super !== null && _super.apply(this, arguments) || this;\n    }\n    /** @override 不能大于0 */\n    PieOuterLabel.prototype.adjustOption = function (options) {\n        _super.prototype.adjustOption.call(this, options);\n        if (options.offset < 0) {\n            options.offset = 0;\n        }\n    };\n    PieOuterLabel.prototype.getDefaultOptions = function () {\n        var theme = this.plot.theme;\n        var labelStyle = theme.label.style;\n        return {\n            offsetX: 0,\n            offsetY: 0,\n            offset: 12,\n            style: __assign(__assign({}, labelStyle), { textBaseline: 'middle' }),\n        };\n    };\n    /** label 碰撞调整 */\n    PieOuterLabel.prototype.layout = function (labels, items, panel) {\n        var _this = this;\n        var center = this.getCoordinate().center;\n        var leftHalf = filter(labels, function (l) { return l.attr('x') <= center.x; });\n        var rightHalf = filter(labels, function (l) { return l.attr('x') > center.x; });\n        [rightHalf, leftHalf].forEach(function (half, isLeft) {\n            _this._antiCollision(half, !isLeft, panel);\n        });\n    };\n    /** labels 碰撞处理（重点算法） */\n    PieOuterLabel.prototype._antiCollision = function (labels, isRight, panelBox) {\n        var _this = this;\n        var labelHeight = this.getLabelHeight(labels);\n        var _a = this.getCoordinate(), center = _a.center, radius = _a.radius;\n        var offset = this.options.offset;\n        var totalR = radius + offset;\n        var totalHeight = Math.min(panelBox.height, Math.max(totalR * 2 + labelHeight * 2, labels.length * labelHeight));\n        var maxLabelsCount = Math.floor(totalHeight / labelHeight);\n        // fix-bug, maxLabelsCount 之后的labels 在非 allowOverlap 不显示（避免出现尾部label展示，而前置label不展示）\n        if (!this.options.allowOverlap) {\n            labels.slice(maxLabelsCount).forEach(function (label) {\n                label.get('parent').set('visible', false);\n            });\n        }\n        labels.splice(maxLabelsCount, labels.length - maxLabelsCount);\n        // sort by y DESC\n        labels.sort(function (a, b) { return a.getBBox().y - b.getBBox().y; });\n        // adjust y position of labels to avoid overlapping\n        var overlapping = true;\n        var i;\n        var maxY = center.y + totalHeight / 2;\n        var minY = center.y - totalHeight / 2;\n        var boxes = labels.map(function (label) {\n            var labelBox = label.getBBox();\n            if (labelBox.maxY > maxY) {\n                maxY = Math.min(panelBox.maxY, labelBox.maxY);\n            }\n            if (labelBox.minY < minY) {\n                minY = Math.max(panelBox.minY, labelBox.minY);\n            }\n            return {\n                text: label.attr('text'),\n                size: labelHeight,\n                pos: labelBox.y,\n                targets: [],\n            };\n        });\n        var j = 0;\n        while (j < boxes.length) {\n            if (j === boxes.length - 1) {\n                boxes[j].targets[0] = maxY;\n            }\n            else {\n                boxes[j].targets[0] = boxes[j + 1].pos - boxes[j + 1].size / 2;\n            }\n            j++;\n        }\n        while (overlapping) {\n            boxes.forEach(function (box) {\n                var target = last(box.targets);\n                box.pos = Math.max(minY, Math.min(box.pos, target - box.size));\n            });\n            // detect overlapping and join boxes\n            overlapping = false;\n            i = boxes.length;\n            while (i--) {\n                if (i > 0) {\n                    var previousBox = boxes[i - 1];\n                    var box = boxes[i];\n                    if (previousBox.pos + previousBox.size > box.pos) {\n                        // overlapping\n                        previousBox.size += box.size;\n                        previousBox.targets = previousBox.targets.concat(box.targets);\n                        // overflow, shift up\n                        var target = last(previousBox.targets);\n                        if (previousBox.pos + previousBox.size > target) {\n                            previousBox.pos = target - previousBox.size;\n                        }\n                        boxes.splice(i, 1); // removing box\n                        overlapping = true;\n                    }\n                    else {\n                        // 换掉最后一个\n                        previousBox.targets.splice(-1, 1, box.pos);\n                    }\n                }\n            }\n        }\n        i = 0;\n        // step 4: normalize y and adjust x\n        boxes.forEach(function (b) {\n            var posInCompositeBox = labelHeight / 2; // middle of the label\n            b.targets.forEach(function () {\n                labels[i].attr('y', b.pos + posInCompositeBox);\n                posInCompositeBox += labelHeight;\n                i++;\n            });\n        });\n        // 调整 x 位置在椭圆轨道上\n        var topLabels = [];\n        var bottomLabels = [];\n        labels.forEach(function (label, idx) {\n            var anchor = _this.arcPoints[idx];\n            if (anchor.angle >= 0 && anchor.angle <= Math.PI) {\n                bottomLabels.push(label);\n            }\n            else {\n                topLabels.push(label);\n            }\n        });\n        [topLabels, bottomLabels].forEach(function (adjustLabels, isBottom) {\n            if (!adjustLabels.length) {\n                return;\n            }\n            var ry = isBottom ? last(adjustLabels).getBBox().maxY - center.y : center.y - head(adjustLabels).getBBox().minY;\n            ry = Math.max(totalR, ry);\n            var distance = offset > 4 ? 4 : 0;\n            var maxLabelWidth = Math.max.apply(0, map(labels, function (label) { return label.getBBox().width; })) +\n                offset +\n                distance;\n            var rx = Math.max(totalR, Math.min((ry + totalR) / 2, center.x - (panelBox.minX + maxLabelWidth)));\n            var rxPow2 = rx * rx;\n            var ryPow2 = ry * ry;\n            adjustLabels.forEach(function (label, idx) {\n                var anchor = _this.arcPoints[idx];\n                var box = label.getBBox();\n                var boxCenter = { x: box.minX + box.width / 2, y: box.minY + box.height / 2 };\n                var dyPow2 = Math.pow(boxCenter.y - center.y, 2);\n                var endPoint = getEndPoint(center, anchor.angle, radius);\n                var distance_offset = (isRight ? 1 : -1) * distance * 2;\n                if (dyPow2 > ryPow2) {\n                    console.warn('异常(一般不会出现)', label.attr('text'));\n                    label.attr('x', endPoint.x + distance_offset);\n                }\n                else {\n                    // (x - cx)^2 / rx ^ 2 + (y - cy)^2 / ry ^ 2 = 1\n                    // 避免 label的 拉线 在 element 上\n                    var xPos = center.x + (isRight ? 1 : -1) * Math.sqrt((1 - dyPow2 / ryPow2) * rxPow2);\n                    if ((center.x === endPoint.x && boxCenter.y === endPoint.y) ||\n                        (center.y === endPoint.y && xPos === endPoint.x)) {\n                        xPos = endPoint.x;\n                    }\n                    else {\n                        // const k1 = (center.y - endPoint.y) / (center.x - endPoint.x);\n                        // const k2 = (boxCenter.y - endPoint.y) / (xPos - endPoint.x);\n                        // const theta = Math.atan((k1 - k2) / (1 + k1 * k2));\n                        // 切角 < 90度（目前的坐标系 无法精准计算切角）\n                        // if (Math.cos(theta) > 0 && (!isRight ? xPos > endPoint.x : xPos < endPoint.x)) {\n                        //   xPos = endPoint.x;\n                        // }\n                    }\n                    label.attr('x', xPos + distance_offset);\n                }\n            });\n        });\n    };\n    /** 获取label height */\n    PieOuterLabel.prototype.getLabelHeight = function (labels) {\n        if (!this.options.labelHeight) {\n            return head(labels) ? head(labels).getBBox().height : 14;\n        }\n        return this.options.labelHeight;\n    };\n    return PieOuterLabel;\n}(PieBaseLabel));\nexport default PieOuterLabel;\n//# sourceMappingURL=outer-label.js.map"]}]}